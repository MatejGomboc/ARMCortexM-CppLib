# Simple Renode test runner for debugging

# Create and configure machine
mach create
machine LoadPlatformDescription @cortex_m0plus_test_platform.repl

# Redirect test output to console
testOutput CreateFileBackend @test_output.txt

# Load test binary
sysbus LoadELF @../build/m0plus_tests

# Set breakpoint at main if debugging
# cpu AddHook `sysbus GetSymbolAddress "main"` "print 'Reached main()'"

# Simple completion check
python """
def on_complete_write(cpu, value):
    if value == 0xDEADBEEF:
        print("\nTEST COMPLETED - Check test_output.txt for results\n")
        quit()
"""

sysbus WriteHookAdd 0x40001000 pythonEngine "on_complete_write"

echo "Running tests..."
start

# Run for 5 seconds max
runFor 5
echo "Test timeout!"
quit
